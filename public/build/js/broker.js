import{mysql}from"./mysql";import{moment}from"./moment";var Bat24,motor_est,te,te_in,hu,hu_su,uv,wa,suma0,suma1,suma2,n=0;const options={clean:!0,connectTimeout:4e3,clientId:"homerosa_web-nueva",username:"homerosa_domo_v6",password:"homerosa_domo_mar120314mar@",keepalive:60},client=mqtt.connect("wss://sistemar.es:8084/mqtt",options);function informacion(){publicar()}function publicar(){client.publish("domo/Salon/recibe/peticion","hola"),client.publish("domo/Taller/recibe/peticion","hola"),client.publish("domo/Puerta/peticion","hola"),client.publish("domo/Piscina/recibe/peticion","hola"),client.publish("domo/Tinaja/recibe/peticion","hola")}function foco(e){let o=e.toString();client.publish("domo/Puerta/foco",o,(function(e){console.log(o)})),document.getElementById("foco_on").style=1==o?"background-color: red":"background-color: #00bcd4;",0==o&&(document.getElementById("foco_on").style="background-color: #00bcd4;")}function puerta(e){let o=e.toString();client.publish("domo/Puerta/control",o)}function motor(){let e;1==++n&&(e="1"),2==n&&(n=0,e="0"),document.getElementById("btn_motor").style="background-color: #f3e5f5",client.publish("domo/Salon/motor/ordenes",e)}function ilu_envio(e){let o=e.toString();client.publish("domo/Salon/ilu/ordenes",o)}function insertar_datos(){var e=mysql.createConnection({host:"localhost",user:"homerosa",password:"homerosa120314",database:"admin_domoV9"});e.connect((function(e){if(e)throw e;console.log("Conexion realizad correctamente a la base de datos")}));var o="INSERT INTO `sensores`(`h`,`d`,`m`,`y`,`te`,`te_in`,`hu`,`hu_su`, `uv`, `wa`) VALUES ("+moment().format("H")+","+moment().format("D")+","+moment().format("M")+","+moment().format("YYYY")+","+te+","+te_in+","+hu+","+hu_su+","+uv+","+wa+");";e.query(o),console.log("Datos insertados en la tabla sensores"),connection.end()}client.on("connect",()=>{client.subscribe("domo/#",e=>{e||publicar()})}),client.on("message",(function(e,o){if("domo/Salon/medidas"==e){let e=o.toString().split(",");document.querySelector(".temp_exte").innerHTML=e[0],document.querySelector(".hume_aire").innerHTML=e[1],console.log("IP Salon -> "+e[2]),document.querySelector(".temp_inte").innerHTML=e[3],document.querySelector(".pilotosalon").style.backgroundColor="green",gas=e[6]}if("domo/Salon/ilu/estado"==e){let e=o.toString().split(","),t=e[0],a=e[1],r=e[2],c=e[3];"1"==t&&document.getElementById("bombilla").classList.add("animacion"),"0"==t&&document.getElementById("bombilla").classList.remove("animacion"),"1"==a&&(document.querySelector(".on").classList.add("activo"),document.querySelector(".auto").classList.remove("activo"),document.querySelector(".off").classList.remove("activo")),"2"==a&&(document.querySelector(".auto").classList.add("activo"),document.querySelector(".on").classList.remove("activo"),document.querySelector(".off").classList.remove("activo")),"0"==a&&(document.querySelector(".off").classList.add("activo"),document.querySelector(".auto").classList.remove("activo"),document.querySelector(".on").classList.remove("activo"));let n=r.split(":");hora_on_ilu=n[0],minu_on_ilu=n[1],hora_on_ilu<10&&(hora_on_ilu="0"+hora_on_ilu),minu_on_ilu<10&&(minu_on_ilu="0"+minu_on_ilu);let l=hora_on_ilu+":"+minu_on_ilu,i=c.split(":");hora_off_ilu=i[0],minu_off_ilu=i[1],hora_off_ilu<10&&(hora_off_ilu="0"+hora_off_ilu),minu_off_ilu<10&&(minu_off_ilu="0"+minu_off_ilu);let s=hora_off_ilu+":"+minu_off_ilu;document.querySelector(".anochecer_placa").innerHTML=l,document.querySelector(".amanecer_placa").innerHTML=s}if("domo/Salon/alarmagas"==e&&(document.querySelector(".alarmaGas").innerHTML="ALARMA, FUGA DE GAS"),"domo/Puerta/general"==e){let e=o.toString().split(",");console.log("IP Puerta verja -> "+e[0]);let t=e[1],a=e[2];document.querySelector(".hume_suelo").innerHTML=e[3],document.querySelector(".pilotopuerta").style.backgroundColor="green",0==a&&(document.getElementById("vehiculos").style="background-color: red"),1==t&&(document.getElementById("paso").style="background-color: red")}if("domo/Puerta/alarmalluvia"==e&&(document.querySelector(".alamaLluvia").innerHTML="Alarma de lluvia"),"domo/Puerta/estado"==e){let e=o.toString();"0"==e&&(document.getElementById("paso").style="background: red;",document.getElementById("vehiculos").style="background: #00bcd4;"),"1"==e&&(document.getElementById("paso").style="background: red;",console.log("Puerta paso abierta")),"2"==e&&(document.getElementById("vehiculos").style="background: red; ",console.log("Puertas vehiculos abiertas"))}if("domo/Taller/medidas"==e){let e=o.toString().split(","),t=e[0],a=e[1],r=e[2];(Bat24=document.querySelector(".Bat24_card").innerHTML=t)?batCard24v(Bat24):document.querySelector(".img_24").src="/build/img/baterias/vacia.png",console.log("IP Taller -> "+a),document.querySelector(".pilototaller").style.backgroundColor="green";let c=document.querySelector(".Bat48_card").innerHTML=r;c?batCard48v(c):document.querySelector(".img_24").src="/build/img/baterias/vacia.png"}if("domo/Taller/motor/estado"==e){let e=o.toString().split(","),d=e[0],_=e[1],y=e[2],v=e[3],S=e[4];1==motor_est&&(n=1),"1"==d&&(document.getElementById("btn_motor").innerHTML="Marcha",document.getElementById("btn_motor").style="background-color: #ce2222",document.getElementById("img_motor").className="animacion"),"0"==d&&(document.getElementById("btn_motor").innerHTML="Parado",document.getElementById("img_motor").className="");var t=Math.floor(_/3600);t=t<10?"0"+t:t;var a=Math.floor(_/60%60);a=a<10?"0"+a:a;var r=_%60;r=r<10?"0"+r:r,document.getElementById("total_horas").innerHTML=t+":"+a+":"+r;var c=Math.floor(y/3600);c=c<10?"0"+c:c;var l=Math.floor(y/60%60);l=l<10?"0"+l:l;var i=y%60;i=i<10?"0"+i:i,document.getElementById("total_mes").innerHTML=c+":"+l+":"+i;var s=Math.floor(v/3600);s=s<10?"0"+s:s;var m=Math.floor(v/60%60);m=m<10?"0"+m:m;var u=v%60;u=u<10?"0"+u:u,document.getElementById("total_ahora").innerHTML=s+":"+m+":"+u,document.getElementById("litros_gasoil").innerHTML=e[4],nivel_Gasoil(S)}if("domo/Taller/termo1"==e){let e=o.toString().split(","),t=e[0],a=e[1],r=e[2],c=e[3];"1"==t&&(document.querySelector(".img_termo1").classList.add("animacion"),document.querySelector(".marcha_termo1").classList.remove("ocultar"),document.querySelector(".parada_termo1").classList.add("ocultar")),"0"==t&&(document.querySelector(".img_termo1").classList.remove("animacion"),document.querySelector(".marcha_termo1").classList.add("ocultar"),document.querySelector(".parada_termo1").classList.remove("ocultar")),"1"==a&&(document.querySelector(".termo1_on").classList.add("activo"),document.querySelector(".termo1_auto").classList.remove("activo"),document.querySelector(".termo1_off").classList.remove("activo")),"2"==a&&(document.querySelector(".termo1_auto").classList.add("activo"),document.querySelector(".termo1_on").classList.remove("activo"),document.querySelector(".termo1_off").classList.remove("activo")),"0"==a&&(document.querySelector(".termo1_off").classList.add("activo"),document.querySelector(".termo1_auto").classList.remove("activo"),document.querySelector(".termo1_on").classList.remove("activo"));let n=r.split(":"),l=n[0],i=n[1];l<10&&(l="0"+l),i<10&&(i="0"+i);let s=l+":"+i,m=c.split(":"),u=m[0],d=m[1];u<10&&(u="0"+u),d<10&&(d="0"+d);let _=u+":"+d;document.querySelector(".encendido_termo1").innerHTML=s,document.querySelector(".apagado_termo1").innerHTML=_}if("domo/Taller/termo3"==e){let e=o.toString().split(","),t=e[0],a=e[1];"1"==t&&(document.querySelector(".img_termo3").classList.add("animacion"),document.querySelector(".marcha_termo3").classList.remove("ocultar"),document.querySelector(".parada_termo3").classList.add("ocultar")),"0"==t&&(document.querySelector(".img_termo3").classList.remove("animacion"),document.querySelector(".marcha_termo3").classList.add("ocultar"),document.querySelector(".parada_termo3").classList.remove("ocultar")),"1"==a&&(document.querySelector(".termo3_on").classList.add("activo"),document.querySelector(".termo3_auto").classList.remove("activo"),document.querySelector(".termo3_off").classList.remove("activo")),"2"==a&&(document.querySelector(".termo3_auto").classList.add("activo"),document.querySelector(".termo3_on").classList.remove("activo"),document.querySelector(".termo3_off").classList.remove("activo")),"0"==a&&(document.querySelector(".termo3_off").classList.add("activo"),document.querySelector(".termo3_auto").classList.remove("activo"),document.querySelector(".termo3_on").classList.remove("activo"))}if("domo/Piscina"==e){let e=o.toString().split(","),t=e[0],a=e[1],r=e[2],c=e[3];document.getElementById("lux").innerHTML=e[4];let n=.0079*e[4];document.getElementById("watios").innerHTML=n.toFixed(2);let l=e[5];console.log(l),funcioniv(l),console.log("IP Piscina -> "+e[6]),document.querySelector(".pilotopiscina").style.backgroundColor="green","1"==t&&(document.querySelector(".img_piscina").classList.add("animacion"),document.querySelector(".marcha").classList.remove("ocultar"),document.querySelector(".parada").classList.add("ocultar")),"0"==t&&(document.querySelector(".img_piscina").classList.remove("animacion"),document.querySelector(".marcha").classList.add("ocultar"),document.querySelector(".parada").classList.remove("ocultar")),"1"==a&&(document.querySelector(".on_piscina").classList.add("activo"),document.querySelector(".auto_piscina").classList.remove("activo"),document.querySelector(".off_piscina").classList.remove("activo")),"2"==a&&(document.querySelector(".auto_piscina").classList.add("activo"),document.querySelector(".on_piscina").classList.remove("activo"),document.querySelector(".off_piscina").classList.remove("activo")),"0"==a&&(document.querySelector(".off_piscina").classList.add("activo"),document.querySelector(".auto_piscina").classList.remove("activo"),document.querySelector(".on_piscina").classList.remove("activo"));let i=r.split(":"),s=i[0],m=i[1];s<10&&(s="0"+s),m<10&&(m="0"+m);let u=s+":"+m,d=c.split(":"),_=d[0],y=d[1];_<10&&(_="0"+_),y<10&&(y="0"+y);let v=_+":"+y;document.querySelector(".encendido_piscina").innerHTML=u,document.querySelector(".apagado_piscina").innerHTML=v}if("domo/Tinaja/nivelagua"==e){let e=o.toString().split(","),t=e[0],a=e[1];document.getElementById("agua").innerHTML=t;let r=t/100;$("#barra-agua").width(r+"%").attr("aria-valuenow",r),nivel_agua(t),console.log("IP Tinaja -> "+a),document.querySelector(".pilototinaja").style.backgroundColor="green"}if("domo/Sensores/puerta"==e){let e=o.toString().split(",");hu_su=e[0],suma0=1}if("domo/Sensores/salon"==e){let e=o.toString().split(",");te=e[0],te_in=e[1],hu=e[2],suma1=1}if("domo/Sensores/piscina"==e){let e=o.toString().split(",");uv=e[0],wa=e[1],suma2=1}suma0+suma1+suma2==3&&(suma0=0,suma1=0,suma2=0,insertar_datos(),console.log(" Se activa la funcion de envio")),1==suma0&&(suma0=0,suma1=0,suma2=0,insertar_datos(),console.log(" Se activa la funcion de envio"))})),setInterval(informacion,1e4);